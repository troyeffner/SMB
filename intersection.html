<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Challenge Intersections — SMB Business Needs</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            line-height: 1.6;
            color: #2d3748;
            background-color: #f7fafc;
        }
        .site-nav {
            background-color: #1a365d;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 12px;
        }
        .site-nav-back {
            color: #a0c4e8;
            text-decoration: none;
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: color 0.2s;
        }
        .site-nav-back:hover {
            color: white;
        }
        .site-nav-back svg {
            width: 14px;
            height: 14px;
        }
        .site-nav-steps {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .nav-step {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            font-weight: 600;
            color: #4a7fa8;
            text-decoration: none;
            transition: color 0.2s;
        }
        .nav-step:hover {
            color: white;
        }
        .nav-step.active {
            color: white;
            cursor: default;
        }
        .nav-step-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #4a7fa8;
        }
        .nav-step.active .nav-step-dot {
            background-color: #2b6cb0;
        }
        .nav-arrow {
            color: #4a7fa8;
            font-size: 14px;
        }
        .hero {
            background-color: #1a365d;
            color: white;
            padding: 40px 20px 36px;
            text-align: center;
            border-top: 1px solid #2a4a7a;
        }
        .step-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background-color: rgba(43, 108, 176, 0.25);
            color: #90cdf4;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            padding: 4px 12px;
            border-radius: 20px;
            margin-bottom: 14px;
        }
        .step-badge-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #2b6cb0;
        }
        .hero h1 {
            font-size: 26px;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 10px;
            letter-spacing: -0.3px;
        }
        .hero p {
            font-size: 15px;
            color: #a0c4e8;
            max-width: 560px;
            margin: 0 auto;
            line-height: 1.5;
        }
        @media (min-width: 768px) {
            .hero h1 { font-size: 32px; }
            .hero p { font-size: 16px; }
        }
        .page-body {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px 120px;
        }
        .container {
            background-color: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 32px;
        }
        h1 {
            color: #1a365d;
            font-size: 28px;
            margin-bottom: 8px;
        }
        .subtitle {
            color: #4a5568;
            font-size: 16px;
            margin-bottom: 24px;
        }
        .instructions {
            background-color: #ebf4ff;
            padding: 16px;
            border-radius: 6px;
            margin-bottom: 32px;
            border-left: 4px solid #2b6cb0;
            font-size: 14px;
        }
        .grid-container {
            overflow-x: auto;
            margin-bottom: 24px;
        }
        .grid {
            display: grid;
            grid-template-columns: 200px repeat(10, 80px);
            gap: 1px;
            background-color: #cbd5e0;
            border: 1px solid #cbd5e0;
        }
        .cell {
            background-color: white;
            padding: 8px;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .header-cell {
            background-color: #028090;
            color: white;
            font-weight: 600;
            font-size: 11px;
            text-align: center;
            writing-mode: vertical-rl;
            transform: rotate(180deg);
            padding: 8px 4px;
        }
        .row-header {
            background-color: #e2e8f0;
            font-weight: 600;
            font-size: 12px;
            text-align: left;
            padding: 8px 12px;
            align-items: center;
            justify-content: flex-start;
        }
        .corner-cell {
            background-color: #1a365d;
        }
        .intersection-cell {
            cursor: pointer;
            transition: all 0.2s;
            font-size: 32px;
        }
        .intersection-cell:hover {
            background-color: #edf2f7;
        }
        .intersection-cell.active {
            background-color: #e6f7f9;
        }
        .cell-marker {
            display: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: #028090;
        }
        .intersection-cell.active .cell-marker {
            display: block;
        }
        .mirror-cell {
            background-color: #e2e8f0;
            cursor: not-allowed;
            pointer-events: none;
        }
        .diagonal-cell {
            background-color: #f7fafc;
            cursor: not-allowed;
        }
        .controls {
            margin-top: 24px;
            display: flex;
            gap: 12px;
            justify-content: center;
        }
        button {
            background-color: #028090;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }
        button:hover {
            background-color: #026670;
        }
        button.secondary {
            background-color: #718096;
        }
        button.secondary:hover {
            background-color: #4a5568;
        }
        .legend {
            margin-top: 24px;
            padding: 16px;
            background-color: #edf2f7;
            border-radius: 6px;
            font-size: 14px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }
        .legend-symbol {
            font-size: 24px;
            width: 30px;
            text-align: center;
        }
        
        /* ── Sticky action bar ── */
        .action-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            border-top: 1px solid #e2e8f0;
            box-shadow: 0 -4px 16px rgba(0,0,0,0.08);
            padding: 14px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            z-index: 100;
        }
        .action-bar-left {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        .selection-count {
            font-size: 14px;
            font-weight: 600;
            color: #2d3748;
        }
        .selection-count span {
            color: #2b6cb0;
        }
        .clear-btn {
            font-size: 13px;
            color: #718096;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            font-weight: 600;
            text-decoration: underline;
            transition: color 0.15s;
        }
        .clear-btn:hover {
            color: #2d3748;
        }
        .clear-btn:disabled {
            opacity: 0.35;
            cursor: default;
            text-decoration: none;
        }
        .next-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background-color: #2b6cb0;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background-color 0.2s;
            white-space: nowrap;
            text-decoration: none;
        }
        .next-btn:hover {
            background-color: #1a4d80;
        }
        .next-btn svg {
            width: 15px;
            height: 15px;
        }
        .footer {
            text-align: center;
            padding: 32px 20px;
            color: #a0aec0;
            font-size: 13px;
            border-top: 1px solid #e2e8f0;
        }
        @page {
            size: letter landscape;
            margin: 0.5in;
        }
        @media print {
            body {
                background-color: white;
            }
            .site-nav, .hero {
                display: none;
            }
            .controls, .action-bar {
                display: none;
            }
            .page-body {
                padding: 0;
                max-width: 100%;
            }
            .container {
                padding: 20px;
                box-shadow: none;
                border-radius: 0;
            }
            /* Print header */
            .print-header {
                display: block !important;
                margin-bottom: 16px;
                padding-bottom: 12px;
                border-bottom: 3px solid #2b6cb0;
            }
            .instructions {
                page-break-after: avoid;
                break-after: avoid;
                margin-bottom: 16px;
                padding: 12px 14px;
            }
            /* Scale the grid to fit landscape page
               Usable width at 0.5in margins on letter landscape ≈ 9.5in = ~912px
               Grid actual width = 200 + (10 × 80) + gaps ≈ 1010px
               Scale factor ≈ 0.88 */
            .grid-container {
                page-break-inside: avoid;
                break-inside: avoid;
                overflow: visible;
                transform-origin: top left;
                transform: scale(0.88);
                width: calc(100% / 0.88);
            }
            .legend {
                margin-top: 16px;
                page-break-inside: avoid;
                break-inside: avoid;
            }
        }
    </style>
</head>
<body>

    <nav class="site-nav">
        <a href="index.html" class="site-nav-back">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
            SMB Business Needs
        </a>
        <div class="site-nav-steps">
            <a href="businessopps.html" class="nav-step">
                <div class="nav-step-dot"></div>
                Discover
            </a>
            <span class="nav-arrow">&rarr;</span>
            <a href="prioritization.html" class="nav-step">
                <div class="nav-step-dot"></div>
                Prioritize
            </a>
            <span class="nav-arrow">&rarr;</span>
            <div class="nav-step active">
                <div class="nav-step-dot"></div>
                Map
            </div>
            <span class="nav-arrow">&rarr;</span>
            <a href="results.html" class="nav-step">
                <div class="nav-step-dot"></div>
                Results
            </a>
        </div>
    </nav>

    <div class="hero">
        <div class="step-badge"><span class="step-badge-dot"></span> Step 3</div>
        <h1>See Where Challenges Collide</h1>
        <p>Click intersections where challenges compound each other to reveal where the real pain concentrates.</p>
    </div>

    <div class="page-body">
    <div class="container">

        <!-- Print-only header (hidden on screen) -->
        <div class="print-header" style="display:none;">
            <h2 style="color:#1a365d; font-size:18px; margin-bottom:4px;">See Where Challenges Collide</h2>
            <div style="color:#4a5568; font-size:12px;">Intersection map — SMB Business Needs Toolkit</div>
        </div>

        <div class="instructions">
            <strong>How to use:</strong> Click any cell in the lower-left triangle where two challenges overlap to mark it as a high-pain point. A teal dot indicates where multiple issues compound each other. Click again to remove.
        </div>

        <div class="grid-container">
            <div class="grid" id="challengeGrid">
                <!-- Grid will be generated by JavaScript -->
            </div>
        </div>

        <!-- Controls removed; replaced by sticky action bar below -->

        <div class="legend">
            <strong>Legend:</strong>
            <div class="legend-item">
                <span class="legend-symbol" style="display:flex;align-items:center;justify-content:center;"><span style="display:inline-block;width:16px;height:16px;border-radius:50%;background-color:#028090;"></span></span>
                <span>High pain point — multiple challenges intersecting</span>
            </div>
            <div class="legend-item">
                <span class="legend-symbol" style="color: #028090;">■</span>
                <span>Column headers - Challenge categories</span>
            </div>
            <div class="legend-item">
                <span class="legend-symbol" style="color: #4a5568;">■</span>
                <span>Row headers - Challenge categories</span>
            </div>
            <div class="legend-item">
                <span class="legend-symbol" style="background-color:#e2e8f0;display:inline-block;width:24px;height:24px;border-radius:3px;"></span>
                <span>Mirror cells — use only the lower-left triangle</span>
            </div>
        </div>
    </div>
    </div>

    <div class="footer">
        SMB Business Needs Toolkit
    </div>

    <!-- Sticky action bar -->
    <div class="action-bar" id="actionBar">
        <div class="action-bar-left">
            <div class="selection-count" id="selectionCount"><span>0</span> intersections marked</div>
            <button class="clear-btn" id="clearBtn" onclick="clearAll()" disabled>Clear all</button>
            <button class="clear-btn" id="pdfBtn" onclick="takeSnapshot()" disabled>Save as PDF</button>
        </div>
        <button class="next-btn" id="nextBtn" onclick="goNext()">
            View My Results
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>
        </button>
    </div>

    <script>
        const categories = [
            { id: 1, short: "Alignment", full: "Alignment & Getting on Same Page" },
            { id: 2, short: "Process", full: "Process Breakdowns & Bottlenecks" },
            { id: 3, short: "Handoffs", full: "Handoffs & Communication Gaps" },
            { id: 4, short: "Workarounds", full: "People Working Around System" },
            { id: 5, short: "Scaling", full: "Scaling & Growth Pains" },
            { id: 6, short: "Technology", full: "Technology & System Integration" },
            { id: 7, short: "Priorities", full: "Priorities & Decision-Making" },
            { id: 8, short: "Quality", full: "Customer or Quality Issues" },
            { id: 9, short: "Onboarding", full: "New Hire Onboarding" },
            { id: 10, short: "Roles", full: "Unclear Roles & Responsibilities" }
        ];

        // ── Read step 1 selections (graceful fallback: all 10 if none) ──
        const smbSelected = (function() {
            try {
                const raw = localStorage.getItem('smb_selected');
                if (raw) { const ids = JSON.parse(raw); if (Array.isArray(ids) && ids.length >= 2) return ids.map(Number); }
            } catch(e) {}
            return null;
        })();
        const activeCategories = smbSelected ? categories.filter(c => smbSelected.includes(c.id)) : categories;

        const activeCells = new Set();
        const countEl = document.getElementById('selectionCount');
        const clearBtn = document.getElementById('clearBtn');
        const pdfBtn = document.getElementById('pdfBtn');

        function updateBar() {
            const n = activeCells.size;
            countEl.innerHTML = `<span>${n}</span> intersection${n === 1 ? '' : 's'} marked`;
            clearBtn.disabled = n === 0;
            pdfBtn.disabled = n === 0;
        }

        function generateGrid() {
            const grid = document.getElementById('challengeGrid');
            const n = activeCategories.length;
            grid.style.gridTemplateColumns = `200px repeat(${n}, 80px)`;

            // Corner cell
            grid.appendChild(createCell('corner-cell'));

            // Column headers
            activeCategories.forEach(cat => {
                const cell = createCell('header-cell');
                cell.textContent = cat.short;
                cell.title = cat.full;
                grid.appendChild(cell);
            });

            // Rows
            activeCategories.forEach((rowCat, rowIdx) => {
                // Row header
                const rowHeader = createCell('row-header');
                rowHeader.textContent = rowCat.short;
                rowHeader.title = rowCat.full;
                grid.appendChild(rowHeader);

                // Intersection cells
                activeCategories.forEach((colCat, colIdx) => {
                    const cell = createCell('intersection-cell');

                    // Gray out diagonal (same category) and upper triangle
                    if (rowIdx === colIdx) {
                        cell.classList.add('diagonal-cell');
                        cell.style.cursor = 'not-allowed';
                    } else if (colIdx > rowIdx) {
                        // Upper triangle — disabled, solid gray
                        cell.classList.add('mirror-cell');
                    } else {
                        const cellId = `${rowCat.id}-${colCat.id}`;
                        cell.setAttribute('data-cell-id', cellId);
                        cell.setAttribute('data-row', rowCat.short);
                        cell.setAttribute('data-col', colCat.short);

                        const marker = document.createElement('span');
                        marker.className = 'cell-marker';
                        cell.appendChild(marker);

                        cell.addEventListener('click', () => toggleCell(cellId, cell));
                    }

                    grid.appendChild(cell);
                });
            });
        }

        function createCell(className) {
            const cell = document.createElement('div');
            cell.className = `cell ${className}`;
            return cell;
        }

        function toggleCell(cellId, element) {
            if (activeCells.has(cellId)) {
                activeCells.delete(cellId);
                element.classList.remove('active');
            } else {
                activeCells.add(cellId);
                element.classList.add('active');
            }
            updateBar();
        }

        function clearAll() {
            activeCells.clear();
            document.querySelectorAll('.intersection-cell.active').forEach(cell => {
                cell.classList.remove('active');
            });
            localStorage.removeItem('smb_intersections');
            updateBar();
        }

        function goNext() {
            localStorage.setItem('smb_intersections', JSON.stringify(Array.from(activeCells)));
            window.location.href = 'results.html';
        }

        function exportData() {
            if (activeCells.size === 0) {
                alert('No pain points marked yet. Click on intersection cells to mark high-pain areas.');
                return;
            }

            let summary = "Challenge Intersections - High Pain Points\n";
            summary += "=".repeat(50) + "\n\n";
            
            const intersections = [];
            activeCells.forEach(cellId => {
                const cell = document.querySelector(`[data-cell-id="${cellId}"]`);
                if (cell) {
                    const row = cell.getAttribute('data-row');
                    const col = cell.getAttribute('data-col');
                    intersections.push(`${row} × ${col}`);
                }
            });
            
            intersections.sort();
            
            summary += `Total high-pain intersections identified: ${intersections.length}\n\n`;
            summary += "Pain Points:\n";
            intersections.forEach((intersection, idx) => {
                summary += `${idx + 1}. ${intersection}\n`;
            });
            
            summary += "\n" + "=".repeat(50) + "\n";
            summary += "These intersections represent areas where multiple challenges\n";
            summary += "compound each other, creating the most significant pain for the business.\n";
            
            // Copy to clipboard
            navigator.clipboard.writeText(summary).then(() => {
                alert(`Summary copied to clipboard!\n\n${intersections.length} high-pain intersections identified.`);
            }).catch(() => {
                // Fallback: show in alert
                alert(summary);
            });
        }

        function takeSnapshot() {
            if (activeCells.size === 0) return;
            const now = new Date();
            const pad = n => String(n).padStart(2, '0');
            const ts = `${now.getFullYear()}_${pad(now.getMonth()+1)}_${pad(now.getDate())}`;
            document.title = `${ts}_Challenge_Intersections`;
            window.print();
        }

        // Initialize grid on page load
        generateGrid();
    </script>
</body>
</html>
